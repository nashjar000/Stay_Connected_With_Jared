<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Stay Connected With Jared</title>
    <link rel="icon" type="image/x-icon" href="images/mylogo.png">
    <script src="./js/themes/themeManager.js"></script>
    <link rel="stylesheet" href="./styles/auth.css">
    <link rel="stylesheet" href="./styles/user-status.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/config.js"></script>
    <script src="./js/supabaseClient.js"></script>
    <script defer src="./js/components/header.js"></script>
    <script defer src="./js/components/footer.js"></script>
    <script defer src="./js/components/mobile-menu.js"></script>
    <script defer src="./js/components/user-status.js"></script>
</head>

<body>
    <div id="header"></div>
    
    <div class="auth-container">
        <div class="auth-box">
            <h1>Login to View Video Journals</h1>
            <p class="auth-description">Please log in to access the video journal content.</p>
            
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>
            
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                
                <button type="submit" class="auth-button" id="login-button">Log In</button>
            </form>

            <div class="auth-forgot">
                <p>Forgot your password?</p>
                <button type="button" class="auth-button secondary" id="forgot-button">Send Reset Link</button>
                <p class="resend-note" id="reset-status" style="display: none;"></p>
            </div>
            
            <div class="auth-switch">
                <p>Don't have an account? <a href="auth-signup.html">Sign up here</a></p>
            </div>
            
            <div class="auth-note">
                <p><strong>Note:</strong> After signing up, your account will need to be approved by Jared before you can access the video journals.</p>
            </div>
        </div>
    </div>
    
    <div id="footer"></div>

    <script>
        // Wait for supabaseClient to load
        window.addEventListener('load', () => {
            document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            const loginButton = document.getElementById('login-button');
            
            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            // Disable button during login
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            
            try {
                const result = await auth.signIn(email, password);
                
                if (!result.success) {
                    errorDiv.textContent = result.error || 'Login failed. Please check your credentials.';
                    errorDiv.style.display = 'block';
                    loginButton.disabled = false;
                    loginButton.textContent = 'Log In';
                    return;
                }
                
                // Check if user is admin first
                const isAdmin = await auth.isAdmin(result.data.user.id);

                // Check if user is approved
                const isApproved = await auth.isUserApproved(result.data.user.id);
                
                // Get redirect URL from query params
                const urlParams = new URLSearchParams(window.location.search);
                const redirect = urlParams.get('redirect') || './pages/video-journals.html';
                
                if (isAdmin) {
                    successDiv.textContent = 'Admin login successful! Redirecting to dashboard...';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = 'admin-dashboard.html';
                    }, 1000);
                } else if (isApproved) {
                    successDiv.textContent = 'Login successful! Redirecting...';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = redirect;
                    }, 1000);
                } else {
                    // Redirect to pending page
                    successDiv.textContent = 'Login successful! Checking approval status...';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = 'auth-pending.html';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'An unexpected error occurred. Please try again.';
                errorDiv.style.display = 'block';
                loginButton.disabled = false;
                loginButton.textContent = 'Log In';
            }
            });

            document.getElementById('forgot-button').addEventListener('click', async () => {
                const email = document.getElementById('email').value.trim();
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                const forgotButton = document.getElementById('forgot-button');
                const resetStatus = document.getElementById('reset-status');

                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                resetStatus.style.display = 'none';

                if (!email) {
                    errorDiv.textContent = 'Please enter your email first.';
                    errorDiv.style.display = 'block';
                    return;
                }

                forgotButton.disabled = true;
                forgotButton.textContent = 'Sending...';

                const result = await auth.resetPassword(email);

                if (!result.success) {
                    errorDiv.textContent = result.error || 'Failed to send reset email.';
                    errorDiv.style.display = 'block';
                    forgotButton.disabled = false;
                    forgotButton.textContent = 'Send Reset Link';
                    return;
                }

                successDiv.textContent = 'Reset email sent! Check your inbox for the reset link.';
                successDiv.style.display = 'block';
                let remaining = 30;
                resetStatus.style.display = 'block';
                resetStatus.textContent = `You can resend in ${remaining}s.`;
                const cooldown = setInterval(() => {
                    remaining -= 1;
                    if (remaining <= 0) {
                        clearInterval(cooldown);
                        resetStatus.textContent = 'You can resend now.';
                        forgotButton.disabled = false;
                        forgotButton.textContent = 'Send Reset Link';
                        return;
                    }
                    resetStatus.textContent = `You can resend in ${remaining}s.`;
                }, 1000);
            });
        });
    </script>
</body>

</html>
